<h2 class="text-center mb-2">وام بانک شهر</h2>

@if (form) {
  <form [formGroup]="form" (ngSubmit)="submit()" class="form-container">
    <div fxLayout="row wrap">
      <div fxFlex="100" fxFlex.gt-xs="33.3">
        <app-custom-select
          formControlName="lenderName"
          [items]="lenders"
          placeholder="نام وام دهنده"
          [required]="true"
          (selectionChange)="lenderChanged($event)"
        ></app-custom-select>
        <mat-error class="custom-error" *ngIf="form.get('lenderName')?.touched && form.get('lenderName')?.hasError('required')">
          نام وام دهنده را انتخاب نمایید.
        </mat-error>
      </div>
      <div fxFlex="100" fxFlex.gt-xs="33.3" class="px-2">
        @if ((branches?.length ?? 0) > 0) {
          <app-custom-select
            formControlName="branchName"
            [items]="branches"
            placeholder="نام شعبه"
            [required]="true"
            (selectionChange)="branchChanged($event)"
          ></app-custom-select>
          <mat-error class="custom-error"
                     *ngIf="form.get('branchName')?.touched && form.get('branchName')?.hasError('required')">
            نام شعبه را انتخاب نمایید.
          </mat-error>
        } @else {
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>نام شعبه</mat-label>
            <mat-select formControlName="branchName" required (selectionChange)="branchChanged($event)">
            </mat-select>
            <mat-error *ngIf="form.get('branchName')?.touched && form.get('branchName')?.hasError('required')">
              نام شعبه را انتخاب نمایید.
            </mat-error>
          </mat-form-field>
        }
      </div>
      <div fxFlex="100" fxFlex.gt-xs="33.3">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>کد شعبه</mat-label>
          <input matInput formControlName="branchCode">
          <mat-error *ngIf="form.get('branchCode')?.touched && form.get('branchCode')?.hasError('required')">
            کد شعبه اجباری می باشد
          </mat-error>
        </mat-form-field>
      </div>
      <!--<div fxFlex="100" fxFlex.gt-xs="50" class="pl-1">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>نام شعبه وام‌دهنده</mat-label>
          <input matInput formControlName="branchName">
          <mat-error *ngIf="form.get('branchName')?.hasError('required')">
            نام شعبه اجباری می باشد
          </mat-error>
        </mat-form-field>
      </div>
      <div fxFlex="100" fxFlex.gt-xs="50" class="pr-1">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>کد شعبه</mat-label>
          <input matInput formControlName="branchCode">
          <mat-error *ngIf="form.get('branchCode')?.hasError('required')">
            کد شعبه اجباری می باشد
          </mat-error>
        </mat-form-field>
      </div>-->
      <div fxFlex="100" fxFlex.gt-xs="33.3">
        <app-currency-input
          label="مبلغ وام درخواستی(ریال)"
          placeholder="مبلغ وام درخواستی(ریال)"
          formControlName="facilityAmount"
          (keyUpEvent)="installmentKeyUpEvent($event)">
        </app-currency-input>
        <mat-error *ngIf="form.get('facilityAmount')?.hasError('required')">
          مبلغ وام اجباری می باشد
        </mat-error>
      </div>
      <div fxFlex="100" fxFlex.gt-xs="33.3" class="px-1">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>تعداد اقساط</mat-label>
          <input matInput [value]="requestTypeConfig?.defaultInstalementCount | customCurrency" [disabled]="true"
                 class="ltr"/>
        </mat-form-field>
      </div>

      <div fxFlex="100" fxFlex.gt-xs="33.3">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>سود وام(%)</mat-label>
          <input matInput [value]="requestTypeConfig?.defaultDiscountPercent | customCurrency" [disabled]="true"
                 class="ltr"/>
        </mat-form-field>
      </div>
      <div fxFlex="100" fxFlex.gt-xs="45">
        <app-currency-input
          label="مبلغ قسط(ریال)"
          placeholder="مبلغ قسط(ریال)"
          formControlName="installmentAmount"
          [disabled]="true">
        </app-currency-input>
        <mat-error *ngIf="form.get('installmentAmount')?.hasError('required')">
          مبلغ قسط اجباری می باشد
        </mat-error>
      </div>
      <div fxFlex="100" fxFlex.gt-xs="10" style="margin-top: 6px">
        <mat-checkbox formControlName="needGuarantor">نیاز به ضامن</mat-checkbox>
      </div>
      @if (form.get('needGuarantor')?.value ?? false) {
        <div fxFlex="100" fxFlex.gt-xs="45" class="px-1">
          مبلغ
          <app-currency-input
            label="مبلغ(ریال)"
            placeholder="مبلغ(ریال)"
            formControlName="guarantorCost"
            [disabled]="true"
            [class]="''">
          </app-currency-input>
          ريال بابت ضمانت سازمان از وام شما کسر گردید.
        </div>
      }
      @if (showDescription) {
        <div fxFlex="100" fxFlex.gt-xs="100">
          <p class="error">
            *درخواست شما در کمیته مطرح می گردد و در صورت تائید وام مورد نظر پرداخت خواهد شد.
            <br>
            مبلغ وام شما از سقف تعیین شده بیشتر است.
            <br>
            لطفاً دلایل درخواست وام را در قسمت توضیحات درج نمایید.
          </p>
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>توضیحات</mat-label>
            <textarea matInput formControlName="requestDescription" rows="3"></textarea>
          </mat-form-field>
        </div>
      }
    </div>

    <div fxLayout="row wrap" fxLayoutAlign="end center">
      <button mat-raised-button color="primary" type="submit">ذخیره و ارسال</button>
    </div>
  </form>
}

<h3>وام بانک شهر قبلی شما</h3>
<mat-divider class="mt-1"></mat-divider>

@if (dataSource) {
  <table [dataSource]="dataSource" class="w-100 my-3" mat-table multiTemplateDataRows>
    @for (column of columnsToDisplay; track column.key) {
      <ng-container matColumnDef="{{column.key}}">
        <th *matHeaderCellDef mat-header-cell>{{ column.name }}</th>
        <td *matCellDef="let element; let i = index;" mat-cell>
          @switch (column.key) {
            @case ('facilityAmount') {
              {{ element.facilityAmount | customCurrency }}
              ريال
            }
            @case ('remainedAmount') {
              {{ (element.remainedAmount ?? 0) | customCurrency }}
              ريال
            }
            @default {
              {{ element[column.key] }}
            }
          }
        </td>
      </ng-container>
    }
    <ng-container matColumnDef="expand">
      <th *matHeaderCellDef aria-label="row actions" mat-header-cell>&nbsp;</th>
    </ng-container>
    <tr *matHeaderRowDef="columnsToDisplay0" mat-header-row></tr>
    <tr *matRowDef="let element; columns: columnsToDisplay0;" class="example-element-row" mat-row>
    </tr>
  </table>
  <!--<mat-paginator [length]="totalCount" [pageSizeOptions]="[10, 50, 100]"></mat-paginator>-->
}
